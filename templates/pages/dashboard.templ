package pages

import (
	"fmt"
	"time"

	"ohabits/internal/database"
	"ohabits/templates/layouts"
	"ohabits/templates/partials"
)

templ Dashboard(user *database.User, data database.DashboardData) {
	@layouts.Base("Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", user) {
		<div class="space-y-4">
			<!-- Weekly Calendar -->
			@weeklyCalendar(data.Date, data.WeekEvents)

			<!-- Calendar Events for Today -->
			if len(data.CalendarEvents) > 0 {
				@calendarEventsToday(data.CalendarEvents)
			}

			<!-- Main Grid -->
			<div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
				<!-- Right Column (RTL first) -->
				<div class="space-y-4 md:space-y-6">
					<!-- Habits -->
					@habitsSection(data.Habits, data.Date)

					<!-- Medications -->
					@medicationsSection(data.Medications, data.Date)

					<!-- Todos -->
					@todosSection(data.Todos, data.Date)
				</div>

				<!-- Left Column -->
				<div class="space-y-4 md:space-y-6">
					<!-- Notes -->
					@notesSection(data.Note, data.Images, data.Date)

					<!-- Mood -->
					@moodSection(data.MoodRating, data.Date)

					<!-- Workout -->
					@workoutSection(data.Workouts, data.WorkoutLog, data.Date)
				</div>
			</div>
		</div>
	}
}

templ calendarEventsToday(events []database.CalendarEventForDay) {
	<div class="retro-card p-3 md:p-4 bg-gradient-to-r from-pink-50 to-purple-50 border-2 border-pink-200">
		<h3 class="section-title text-base mb-3 flex items-center gap-2">
			<span>ğŸŠ</span>
			<span>Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</span>
		</h3>
		@partials.CalendarEventsSection(events)
	</div>
}

templ weeklyCalendar(selectedDate time.Time, weekEvents map[string]bool) {
	<div class="retro-card p-3 md:p-4" x-data="{ showPicker: false }">
		<!-- Current Date Display -->
		<div class="text-center mb-3">
			<h2 class="text-2xl md:text-3xl font-extrabold text-retro-dark">{ getArabicDay(selectedDate.Weekday()) }</h2>
			<p class="text-primary-600 font-semibold text-sm md:text-base">{ formatArabicDate(selectedDate) }</p>
		</div>

		<!-- Week Days Navigation -->
		<div class="flex justify-center gap-1 md:gap-2 mb-3 overflow-x-auto scrollbar-hide py-2">
			for _, day := range getWeekDays(selectedDate) {
				<a
					href={ templ.SafeURL(fmt.Sprintf("/?date=%s", day.Format("2006-01-02"))) }
					class={
						"flex flex-col items-center p-2 md:p-3 rounded-xl min-w-[48px] md:min-w-[56px] transition-all relative",
						templ.KV("bg-primary-500 text-white shadow-lg", isSameDay(day, selectedDate)),
						templ.KV("bg-cream-100 hover:bg-primary-100 text-retro-dark border-2 border-accent-gold", !isSameDay(day, selectedDate) && isWeekend(day)),
						templ.KV("bg-cream-100 hover:bg-primary-100 text-retro-dark", !isSameDay(day, selectedDate) && !isWeekend(day)),
						templ.KV("ring-2 ring-primary-300", isToday(day) && !isSameDay(day, selectedDate)),
					}
				>
					<span class="text-xs font-medium">{ getShortArabicDay(day.Weekday()) }</span>
					<span class="text-lg md:text-xl font-bold">{ fmt.Sprintf("%d", day.Day()) }</span>
					// Event indicator dot
					if hasEvent(weekEvents, day) {
						if isSameDay(day, selectedDate) {
							<span style="position: absolute; top: 2px; left: 2px; width: 8px; height: 8px; background-color: white; border-radius: 50%; box-shadow: 0 0 0 2px #F472B6;"></span>
						} else {
							<span style="position: absolute; top: 2px; left: 2px; width: 8px; height: 8px; background-color: #F472B6; border-radius: 50%;"></span>
						}
					}
				</a>
			}
		</div>

		<!-- Navigation Buttons -->
		<div class="flex justify-center items-center gap-2 flex-wrap">
			<a
				href={ templ.SafeURL(fmt.Sprintf("/?date=%s", selectedDate.AddDate(0, 0, -7).Format("2006-01-02"))) }
				class="anime-btn px-3 py-1.5 text-xs md:text-sm"
			>
				Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¨Ù‚
			</a>

			if !isToday(selectedDate) {
				<a
					href="/"
					class="anime-btn px-3 py-1.5 text-xs md:text-sm"
				>
					Ø§Ù„ÙŠÙˆÙ…
				</a>
			}

			<a
				href={ templ.SafeURL(fmt.Sprintf("/?date=%s", selectedDate.AddDate(0, 0, 7).Format("2006-01-02"))) }
				class="anime-btn px-3 py-1.5 text-xs md:text-sm"
			>
				Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…
			</a>

			<button
				@click="showPicker = !showPicker"
				class="anime-btn px-3 py-1.5 text-xs md:text-sm"
			>
				ğŸ“…
			</button>
		</div>

		<!-- Date Picker -->
		<div x-show="showPicker" x-transition class="mt-3 text-center">
			<input
				type="date"
				value={ selectedDate.Format("2006-01-02") }
				class="retro-input text-center"
				@change="window.location.href = '/?date=' + $event.target.value"
			/>
		</div>
	</div>
}

templ habitsSection(habits []database.HabitWithCompletion, date time.Time) {
	<div class="retro-card p-4 md:p-5">
		<h3 class="section-title text-lg md:text-xl mb-3 md:mb-4">Ø¹Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>

		<div id="habits-list">
			@partials.HabitsList(habits, date)
		</div>
	</div>
}

templ medicationsSection(medications []database.MedicationWithDoses, date time.Time) {
	<div class="retro-card p-4 md:p-5">
		<h3 class="section-title text-lg md:text-xl mb-3 md:mb-4">Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</h3>

		<div id="medications-list">
			@partials.MedicationsList(medications, date)
		</div>
	</div>
}

templ todosSection(todos []database.Todo, date time.Time) {
	<div class="retro-card p-4 md:p-5">
		<h3 class="section-title text-lg md:text-xl mb-3 md:mb-4">Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…</h3>

		<!-- Add Todo Form -->
		<form
			hx-post="/todos"
			hx-target="#todos-list"
			hx-swap="innerHTML"
			class="flex gap-2 mb-3 md:mb-4"
		>
			<input type="hidden" name="date" value={ date.Format("2006-01-02") }/>
			<input
				type="text"
				name="text"
				placeholder="Ø£Ø¶Ù Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©..."
				class="retro-input flex-1 text-sm md:text-base py-2 md:py-3"
				required
			/>
			<button type="submit" class="anime-btn px-3 md:px-4 py-2 text-sm">Ø¥Ø¶Ø§ÙØ©</button>
		</form>

		<div id="todos-list">
			@partials.TodosList(todos, date)
		</div>
	</div>
}

templ notesSection(note *database.Note, images []database.DailyImage, date time.Time) {
	<div class="retro-card p-4 md:p-5" id="note-section">
		@partials.NoteSection(note, images, date)
	</div>
}

templ moodSection(mood *database.MoodRating, date time.Time) {
	<div class="retro-card p-4 md:p-5" id="mood-section">
		@partials.MoodSection(mood, date)
	</div>
}

templ workoutSection(workouts []database.Workout, log *database.WorkoutLog, date time.Time) {
	<div class="retro-card p-4 md:p-5" id="workout-section">
		@partials.WorkoutSection(workouts, log, date)
	</div>
}

// Helper functions
func getArabicDay(weekday time.Weekday) string {
	days := map[time.Weekday]string{
		time.Sunday:    "Ø§Ù„Ø£Ø­Ø¯",
		time.Monday:    "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†",
		time.Tuesday:   "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡",
		time.Wednesday: "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡",
		time.Thursday:  "Ø§Ù„Ø®Ù…ÙŠØ³",
		time.Friday:    "Ø§Ù„Ø¬Ù…Ø¹Ø©",
		time.Saturday:  "Ø§Ù„Ø³Ø¨Øª",
	}
	return days[weekday]
}

func getShortArabicDay(weekday time.Weekday) string {
	days := map[time.Weekday]string{
		time.Sunday:    "Ø£Ø­Ø¯",
		time.Monday:    "Ø§Ø«Ù†",
		time.Tuesday:   "Ø«Ù„Ø§",
		time.Wednesday: "Ø£Ø±Ø¨",
		time.Thursday:  "Ø®Ù…ÙŠ",
		time.Friday:    "Ø¬Ù…Ø¹",
		time.Saturday:  "Ø³Ø¨Øª",
	}
	return days[weekday]
}

func formatArabicDate(date time.Time) string {
	months := []string{
		"ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ",
		"ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±",
	}
	return fmt.Sprintf("%d %s %d", date.Day(), months[date.Month()-1], date.Year())
}

func getWeekDays(selectedDate time.Time) []time.Time {
	// Find the start of the week (Sunday for Arabic calendar)
	// In Go, Sunday = 0
	weekday := int(selectedDate.Weekday())
	startOfWeek := selectedDate.AddDate(0, 0, -weekday)

	days := make([]time.Time, 7)
	for i := 0; i < 7; i++ {
		days[i] = startOfWeek.AddDate(0, 0, i)
	}
	return days
}

// isWeekend returns true if the day is Friday or Saturday (Kuwait weekend)
func isWeekend(date time.Time) bool {
	weekday := date.Weekday()
	return weekday == time.Friday || weekday == time.Saturday
}

func isSameDay(a, b time.Time) bool {
	return a.Year() == b.Year() && a.Month() == b.Month() && a.Day() == b.Day()
}

func isToday(date time.Time) bool {
	// Use Kuwait timezone
	kuwaitTZ := time.FixedZone("Asia/Kuwait", 3*60*60)
	now := time.Now().In(kuwaitTZ)
	return date.Year() == now.Year() && date.Month() == now.Month() && date.Day() == now.Day()
}

func hasEvent(weekEvents map[string]bool, day time.Time) bool {
	if weekEvents == nil {
		return false
	}
	return weekEvents[day.Format("2006-01-02")]
}
