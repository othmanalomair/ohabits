package pages

import (
	"fmt"
	"time"

	"ohabits/internal/database"
	"ohabits/templates/layouts"
)

// SF Symbol to emoji mapping for web display
var medIconToEmoji = map[string]string{
	"pill.fill":                "ğŸ’Š",
	"pills.fill":               "ğŸ’Š",
	"cross.case.fill":          "ğŸ¥",
	"syringe.fill":             "ğŸ’‰",
	"drop.fill":                "ğŸ’§",
	"ivfluid.bag.fill":         "ğŸ©¸",
	"bandage.fill":             "ğŸ©¹",
	"medical.thermometer.fill": "ğŸŒ¡ï¸",
	"heart.fill":               "â¤ï¸",
	"lungs.fill":               "ğŸ«",
	"brain.head.profile":       "ğŸ§ ",
	"eye.fill":                 "ğŸ‘ï¸",
	"ear.fill":                 "ğŸ‘‚",
	"hand.raised.fill":         "âœ‹",
	"figure.walk":              "ğŸš¶",
	"sun.max.fill":             "â˜€ï¸",
	"moon.fill":                "ğŸŒ™",
	"leaf.fill":                "ğŸƒ",
	"flask.fill":               "ğŸ§ª",
	"testtube.2":               "ğŸ§«",
}

// GetMedIconEmoji returns the emoji for an SF Symbol name
func GetMedIconEmoji(icon string) string {
	if emoji, ok := medIconToEmoji[icon]; ok {
		return emoji
	}
	return "ğŸ’Š" // default
}

// MedIconOptions list of available icons
var MedIconOptions = []string{
	"pill.fill",
	"pills.fill",
	"cross.case.fill",
	"syringe.fill",
	"drop.fill",
	"ivfluid.bag.fill",
	"bandage.fill",
	"medical.thermometer.fill",
	"heart.fill",
	"lungs.fill",
	"brain.head.profile",
	"eye.fill",
	"ear.fill",
	"hand.raised.fill",
	"figure.walk",
	"sun.max.fill",
	"moon.fill",
	"leaf.fill",
	"flask.fill",
	"testtube.2",
}

templ MedicationsPage(user *database.User, medications []database.Medication) {
	@layouts.Base("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ©", user) {
		<div class="max-w-2xl mx-auto space-y-4">
			<!-- Header -->
			<div class="retro-card p-4 md:p-5">
				<div class="flex items-center justify-between mb-4">
					<h1 class="text-xl md:text-2xl font-bold text-retro-dark">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</h1>
					<a href="/" class="anime-btn px-3 py-1.5 text-sm">
						â† Ø§Ù„Ø±Ø¬ÙˆØ¹
					</a>
				</div>
				<p class="text-sm text-gray-600">Ø£Ø¶Ù Ø£Ø¯ÙˆÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ø¹Ø¯Ù‘Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©</p>
			</div>

			<!-- Add New Medication Form -->
			<div class="retro-card p-4 md:p-5">
				<h2 class="section-title text-lg mb-4">Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡ Ø¬Ø¯ÙŠØ¯</h2>

				<form
					hx-post="/medications"
					hx-target="#medications-list"
					hx-swap="innerHTML"
					hx-on::after-request="if(event.detail.successful) this.reset()"
					class="space-y-4"
					x-data="{ durationType: 'lifetime', selectedIcon: 'pill.fill' }"
				>
					<div class="grid grid-cols-2 gap-3">
						<div class="col-span-2">
							<label class="block text-sm font-semibold text-primary-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡</label>
							<input
								type="text"
								name="name"
								placeholder="Ù…Ø«Ø§Ù„: ÙÙŠØªØ§Ù…ÙŠÙ† Ø¯"
								class="retro-input w-full"
								required
							/>
						</div>

						<div>
							<label class="block text-sm font-semibold text-primary-700 mb-1">Ø§Ù„Ø¬Ø±Ø¹Ø©</label>
							<input
								type="text"
								name="dosage"
								placeholder="Ù…Ø«Ø§Ù„: 1000 ÙˆØ­Ø¯Ø©"
								class="retro-input w-full"
							/>
						</div>

						<div>
							<label class="block text-sm font-semibold text-primary-700 mb-1">Ù…Ø±Ø§Øª Ø¨Ø§Ù„ÙŠÙˆÙ…</label>
							<select name="times_per_day" class="retro-input w-full">
								<option value="1">Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©</option>
								<option value="2">Ù…Ø±ØªÙŠÙ†</option>
								<option value="3">3 Ù…Ø±Ø§Øª</option>
								<option value="4">4 Ù…Ø±Ø§Øª</option>
							</select>
						</div>
					</div>

					<!-- Icon Picker -->
					<div>
						<label class="block text-sm font-semibold text-primary-700 mb-2">Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©</label>
						<div class="grid grid-cols-10 gap-2">
							for _, icon := range MedIconOptions {
								@medIconRadio(icon, "icon", "pill.fill")
							}
						</div>
					</div>

					<div>
						<label class="block text-sm font-semibold text-primary-700 mb-2">Ø£ÙŠØ§Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡</label>
						<div class="flex flex-wrap gap-2">
							@medDayCheckbox("0", "Ø£Ø­Ø¯", true)
							@medDayCheckbox("1", "Ø§Ø«Ù†ÙŠÙ†", true)
							@medDayCheckbox("2", "Ø«Ù„Ø§Ø«Ø§Ø¡", true)
							@medDayCheckbox("3", "Ø£Ø±Ø¨Ø¹Ø§Ø¡", true)
							@medDayCheckbox("4", "Ø®Ù…ÙŠØ³", true)
							@medDayCheckbox("5", "Ø¬Ù…Ø¹Ø©", true)
							@medDayCheckbox("6", "Ø³Ø¨Øª", true)
						</div>
						<p class="text-xs text-gray-500 mt-1">Ø§ØªØ±Ùƒ Ø§Ù„ÙƒÙ„ Ù…Ø­Ø¯Ø¯ Ù„Ù„Ø¯ÙˆØ§Ø¡ Ø§Ù„ÙŠÙˆÙ…ÙŠ</p>
					</div>

					<div>
						<label class="block text-sm font-semibold text-primary-700 mb-2">Ù…Ø¯Ø© Ø§Ù„Ø¯ÙˆØ§Ø¡</label>
						<div class="flex gap-4">
							<label class="flex items-center gap-2 cursor-pointer">
								<input
									type="radio"
									name="duration_type"
									value="lifetime"
									x-model="durationType"
									class="w-4 h-4 text-primary-600"
									checked
								/>
								<span class="text-sm">Ù…Ø³ØªÙ…Ø± (Ù…Ø¯Ù‰ Ø§Ù„Ø­ÙŠØ§Ø©)</span>
							</label>
							<label class="flex items-center gap-2 cursor-pointer">
								<input
									type="radio"
									name="duration_type"
									value="limited"
									x-model="durationType"
									class="w-4 h-4 text-primary-600"
								/>
								<span class="text-sm">Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø¯Ø©</span>
							</label>
						</div>
					</div>

					<div x-show="durationType === 'limited'" x-transition class="grid grid-cols-2 gap-3">
						<div>
							<label class="block text-sm font-semibold text-primary-700 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
							<input
								type="date"
								name="start_date"
								class="retro-input w-full"
							/>
						</div>
						<div>
							<label class="block text-sm font-semibold text-primary-700 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label>
							<input
								type="date"
								name="end_date"
								class="retro-input w-full"
							/>
						</div>
					</div>

					<div>
						<label class="block text-sm font-semibold text-primary-700 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
						<textarea
							name="notes"
							placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"
							class="retro-input w-full h-20 resize-none"
						></textarea>
					</div>

					<button type="submit" class="anime-btn w-full py-2.5">
						+ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡
					</button>
				</form>
			</div>

			<!-- Medications List -->
			<div class="retro-card p-4 md:p-5">
				<h2 class="section-title text-lg mb-4">Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ({ fmt.Sprintf("%d", len(medications)) })</h2>

				<div id="medications-list">
					@MedicationsManageList(medications)
				</div>
			</div>
		</div>
	}
}

templ MedicationsManageList(medications []database.Medication) {
	if len(medications) == 0 {
		<p class="text-gray-400 text-center py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆÙŠØ© Ø¨Ø¹Ø¯. Ø£Ø¶Ù Ø¯ÙˆØ§Ø¡Ùƒ Ø§Ù„Ø£ÙˆÙ„!</p>
	} else {
		<div class="space-y-3">
			for _, med := range medications {
				@MedicationManageItem(med)
			}
		</div>
	}
}

templ MedicationManageItem(med database.Medication) {
	<div
		id={ "med-manage-" + med.ID.String() }
		class={ "bg-cream-100 rounded-xl p-4 border-2", templ.KV("border-primary-200", med.IsActive), templ.KV("border-gray-300 opacity-60", !med.IsActive) }
		x-data="{ editing: false }"
	>
		<!-- View Mode -->
		<div x-show="!editing">
			<div class="flex items-start justify-between gap-3">
				<div class="flex items-start gap-3 flex-1">
					<!-- Icon -->
					<div class="w-10 h-10 flex items-center justify-center rounded-lg bg-primary-100 text-xl flex-shrink-0">
						{ GetMedIconEmoji(med.Icon) }
					</div>
					<div class="flex-1">
						<div class="flex items-center gap-2">
							<h3 class="font-bold text-retro-dark">{ med.Name }</h3>
							if !med.IsActive {
								<span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded">Ù…ØªÙˆÙ‚Ù</span>
							}
						</div>
						if med.Dosage != "" {
							<p class="text-sm text-primary-600">{ med.Dosage }</p>
						}
						<div class="flex flex-wrap gap-2 mt-2 text-xs text-gray-600">
							<span class="bg-cream-200 px-2 py-0.5 rounded">{ fmt.Sprintf("%d Ù…Ø±Ø©/ÙŠÙˆÙ…", med.TimesPerDay) }</span>
							if med.DurationType == "lifetime" {
								<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded">Ù…Ø³ØªÙ…Ø±</span>
							} else {
								<span class="bg-orange-100 text-orange-700 px-2 py-0.5 rounded">Ù…Ø­Ø¯ÙˆØ¯</span>
							}
						</div>
						if len(med.ScheduledDays) > 0 && len(med.ScheduledDays) < 7 {
							<div class="flex flex-wrap gap-1 mt-2">
								for _, day := range med.ScheduledDays {
									<span class="retro-badge text-xs">{ getMedArabicDayName(day) }</span>
								}
							</div>
						}
						if med.Notes != "" {
							<p class="text-xs text-gray-500 mt-2 italic">{ med.Notes }</p>
						}
					</div>
				</div>
				<div class="flex gap-2">
					<button
						@click="editing = true"
						class="text-primary-600 hover:text-primary-800 p-1"
						title="ØªØ¹Ø¯ÙŠÙ„"
					>
						<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
						</svg>
					</button>
					<button
						hx-delete={ "/medications/" + med.ID.String() }
						hx-target="#medications-list"
						hx-swap="innerHTML"
						hx-confirm="Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ§Ø¡ØŸ"
						class="text-red-500 hover:text-red-700 p-1"
						title="Ø­Ø°Ù"
					>
						<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
						</svg>
					</button>
				</div>
			</div>
		</div>

		<!-- Edit Mode -->
		<div x-show="editing" x-cloak>
			<form
				hx-put={ "/medications/" + med.ID.String() }
				hx-target={ "#med-manage-" + med.ID.String() }
				hx-swap="outerHTML"
				class="space-y-3"
				x-data={ fmt.Sprintf("{ durationType: '%s', selectedIcon: '%s' }", med.DurationType, med.Icon) }
			>
				<div class="grid grid-cols-2 gap-2">
					<div class="col-span-2">
						<label class="block text-xs font-semibold text-primary-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡</label>
						<input
							type="text"
							name="name"
							value={ med.Name }
							class="retro-input w-full text-sm"
							required
						/>
					</div>

					<div>
						<label class="block text-xs font-semibold text-primary-700 mb-1">Ø§Ù„Ø¬Ø±Ø¹Ø©</label>
						<input
							type="text"
							name="dosage"
							value={ med.Dosage }
							class="retro-input w-full text-sm"
						/>
					</div>

					<div>
						<label class="block text-xs font-semibold text-primary-700 mb-1">Ù…Ø±Ø§Øª Ø¨Ø§Ù„ÙŠÙˆÙ…</label>
						<select name="times_per_day" class="retro-input w-full text-sm">
							<option value="1" selected?={ med.TimesPerDay == 1 }>Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©</option>
							<option value="2" selected?={ med.TimesPerDay == 2 }>Ù…Ø±ØªÙŠÙ†</option>
							<option value="3" selected?={ med.TimesPerDay == 3 }>3 Ù…Ø±Ø§Øª</option>
							<option value="4" selected?={ med.TimesPerDay == 4 }>4 Ù…Ø±Ø§Øª</option>
						</select>
					</div>
				</div>

				<!-- Icon Picker (Edit) -->
				<div>
					<label class="block text-xs font-semibold text-primary-700 mb-2">Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©</label>
					<div class="grid grid-cols-10 gap-1">
						for _, icon := range MedIconOptions {
							@medIconRadioEdit(icon, "icon", med.Icon)
						}
					</div>
				</div>

				<div>
					<label class="block text-xs font-semibold text-primary-700 mb-2">Ø£ÙŠØ§Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡</label>
					<div class="flex flex-wrap gap-2">
						@medDayCheckboxEdit("0", "Ø£Ø­Ø¯", isMedDaySelected(med.ScheduledDays, "Sunday"))
						@medDayCheckboxEdit("1", "Ø§Ø«Ù†ÙŠÙ†", isMedDaySelected(med.ScheduledDays, "Monday"))
						@medDayCheckboxEdit("2", "Ø«Ù„Ø§Ø«Ø§Ø¡", isMedDaySelected(med.ScheduledDays, "Tuesday"))
						@medDayCheckboxEdit("3", "Ø£Ø±Ø¨Ø¹Ø§Ø¡", isMedDaySelected(med.ScheduledDays, "Wednesday"))
						@medDayCheckboxEdit("4", "Ø®Ù…ÙŠØ³", isMedDaySelected(med.ScheduledDays, "Thursday"))
						@medDayCheckboxEdit("5", "Ø¬Ù…Ø¹Ø©", isMedDaySelected(med.ScheduledDays, "Friday"))
						@medDayCheckboxEdit("6", "Ø³Ø¨Øª", isMedDaySelected(med.ScheduledDays, "Saturday"))
					</div>
				</div>

				<div>
					<label class="block text-xs font-semibold text-primary-700 mb-1">Ù…Ø¯Ø© Ø§Ù„Ø¯ÙˆØ§Ø¡</label>
					<div class="flex gap-3">
						<label class="flex items-center gap-1.5 cursor-pointer">
							<input
								type="radio"
								name="duration_type"
								value="lifetime"
								x-model="durationType"
								class="w-3.5 h-3.5 text-primary-600"
							/>
							<span class="text-xs">Ù…Ø³ØªÙ…Ø±</span>
						</label>
						<label class="flex items-center gap-1.5 cursor-pointer">
							<input
								type="radio"
								name="duration_type"
								value="limited"
								x-model="durationType"
								class="w-3.5 h-3.5 text-primary-600"
							/>
							<span class="text-xs">Ù…Ø­Ø¯ÙˆØ¯</span>
						</label>
					</div>
				</div>

				<div x-show="durationType === 'limited'" x-transition class="grid grid-cols-2 gap-2">
					<div>
						<label class="block text-xs font-semibold text-primary-700 mb-1">Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
						<input
							type="date"
							name="start_date"
							value={ formatDateForInput(med.StartDate) }
							class="retro-input w-full text-sm"
						/>
					</div>
					<div>
						<label class="block text-xs font-semibold text-primary-700 mb-1">Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label>
						<input
							type="date"
							name="end_date"
							value={ formatDateForInput(med.EndDate) }
							class="retro-input w-full text-sm"
						/>
					</div>
				</div>

				<div>
					<label class="block text-xs font-semibold text-primary-700 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
					<textarea
						name="notes"
						class="retro-input w-full h-16 resize-none text-sm"
					>{ med.Notes }</textarea>
				</div>

				<div>
					<label class="flex items-center gap-2 cursor-pointer">
						<input
							type="checkbox"
							name="is_active"
							if med.IsActive {
								checked
							}
							class="w-4 h-4 rounded border-primary-300 text-primary-600"
						/>
						<span class="text-sm text-retro-dark">Ø§Ù„Ø¯ÙˆØ§Ø¡ ÙØ¹Ø§Ù„</span>
					</label>
				</div>

				<div class="flex gap-2 pt-2">
					<button type="submit" class="anime-btn flex-1 py-2 text-sm">
						Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
					</button>
					<button
						type="button"
						@click="editing = false"
						class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 bg-gray-100 rounded-lg"
					>
						Ø¥Ù„ØºØ§Ø¡
					</button>
				</div>
			</form>
		</div>
	</div>
}

templ medIconRadio(icon string, inputName string, defaultIcon string) {
	<label class="cursor-pointer">
		<input 
			type="radio" 
			name={ inputName }
			value={ icon }
			class="sr-only peer"
			x-model="selectedIcon"
			if icon == defaultIcon {
				checked
			}
		/>
		<div class="w-8 h-8 flex items-center justify-center rounded-lg text-lg bg-cream-100 border-2 border-gray-200 hover:border-primary-400 transition-colors peer-checked:border-primary-500 peer-checked:bg-primary-50">
			{ GetMedIconEmoji(icon) }
		</div>
	</label>
}

templ medIconRadioEdit(icon string, inputName string, selectedIcon string) {
	<label class="cursor-pointer">
		<input 
			type="radio" 
			name={ inputName }
			value={ icon }
			class="sr-only peer"
			x-model="selectedIcon"
			if icon == selectedIcon {
				checked
			}
		/>
		<div class="w-7 h-7 flex items-center justify-center rounded text-sm bg-cream-100 border border-gray-200 hover:border-primary-400 transition-colors peer-checked:border-primary-500 peer-checked:bg-primary-50">
			{ GetMedIconEmoji(icon) }
		</div>
	</label>
}

templ medDayCheckbox(index string, label string, checked bool) {
	<label class="flex items-center gap-1.5 cursor-pointer">
		<input
			type="checkbox"
			name={ "day_" + index }
			if checked {
				checked
			}
			class="w-4 h-4 rounded border-primary-300 text-primary-600 focus:ring-primary-500"
		/>
		<span class="text-sm text-retro-dark">{ label }</span>
	</label>
}

templ medDayCheckboxEdit(index string, label string, checked bool) {
	<label class="flex items-center gap-1.5 cursor-pointer">
		<input
			type="checkbox"
			name={ "day_" + index }
			if checked {
				checked
			}
			class="w-4 h-4 rounded border-primary-300 text-primary-600 focus:ring-primary-500"
		/>
		<span class="text-xs text-retro-dark">{ label }</span>
	</label>
}

func getMedArabicDayName(day string) string {
	days := map[string]string{
		"Sunday":    "Ø£Ø­Ø¯",
		"Monday":    "Ø§Ø«Ù†ÙŠÙ†",
		"Tuesday":   "Ø«Ù„Ø§Ø«Ø§Ø¡",
		"Wednesday": "Ø£Ø±Ø¨Ø¹Ø§Ø¡",
		"Thursday":  "Ø®Ù…ÙŠØ³",
		"Friday":    "Ø¬Ù…Ø¹Ø©",
		"Saturday":  "Ø³Ø¨Øª",
	}
	if name, ok := days[day]; ok {
		return name
	}
	return day
}

func isMedDaySelected(days []string, day string) bool {
	// If no days selected, all days are selected (daily medication)
	if len(days) == 0 {
		return true
	}
	for _, d := range days {
		if d == day {
			return true
		}
	}
	return false
}

func formatDateForInput(t *time.Time) string {
	if t == nil {
		return ""
	}
	return t.Format("2006-01-02")
}
