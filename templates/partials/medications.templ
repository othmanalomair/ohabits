package partials

import (
	"fmt"
	"time"

	"ohabits/internal/database"
)

// SF Symbol to emoji mapping for web display
var partialMedIconToEmoji = map[string]string{
	"pill.fill":                "ðŸ’Š",
	"pills.fill":               "ðŸ’Š",
	"cross.case.fill":          "ðŸ¥",
	"syringe.fill":             "ðŸ’‰",
	"drop.fill":                "ðŸ’§",
	"ivfluid.bag.fill":         "ðŸ©¸",
	"bandage.fill":             "ðŸ©¹",
	"medical.thermometer.fill": "ðŸŒ¡ï¸",
	"heart.fill":               "â¤ï¸",
	"lungs.fill":               "ðŸ«",
	"brain.head.profile":       "ðŸ§ ",
	"eye.fill":                 "ðŸ‘ï¸",
	"ear.fill":                 "ðŸ‘‚",
	"hand.raised.fill":         "âœ‹",
	"figure.walk":              "ðŸš¶",
	"sun.max.fill":             "â˜€ï¸",
	"moon.fill":                "ðŸŒ™",
	"leaf.fill":                "ðŸƒ",
	"flask.fill":               "ðŸ§ª",
	"testtube.2":               "ðŸ§«",
}

// getPartialMedIconEmoji returns the emoji for an SF Symbol name
func getPartialMedIconEmoji(icon string) string {
	if emoji, ok := partialMedIconToEmoji[icon]; ok {
		return emoji
	}
	return "ðŸ’Š" // default
}

// allDosesTaken checks if all doses are taken
func allDosesTaken(doseTaken []bool) bool {
	for _, taken := range doseTaken {
		if !taken {
			return false
		}
	}
	return len(doseTaken) > 0
}

// countTakenDoses counts how many doses are taken
func countTakenDoses(doseTaken []bool) int {
	count := 0
	for _, taken := range doseTaken {
		if taken {
			count++
		}
	}
	return count
}

// getNextDoseNumber returns the next dose to take (1-based), or 0 if all taken
func getNextDoseNumber(doseTaken []bool) int {
	for i, taken := range doseTaken {
		if !taken {
			return i + 1
		}
	}
	return 0 // all taken, will reset
}

templ MedicationsList(medications []database.MedicationWithDoses, date time.Time) {
	if len(medications) == 0 {
		<p class="text-gray-400 text-center py-4 text-sm md:text-base">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</p>
	} else {
		<div class="space-y-2 md:space-y-3">
			for _, med := range medications {
				@MedicationItem(med, date, allDosesTaken(med.DoseTaken), 0)
			}
		</div>
	}
}

templ MedicationItem(med database.MedicationWithDoses, date time.Time, taken bool, toggledDose int) {
	<div
		id={ "med-" + med.ID.String() }
		class={ "med-item flex items-center justify-between gap-2 p-3 md:p-4", templ.KV("taken", taken) }
	>
		<div class="flex items-center gap-3 flex-1 min-w-0">
			<!-- Icon -->
			<div class={ "w-10 h-10 flex items-center justify-center rounded-lg text-xl flex-shrink-0", templ.KV("bg-green-100", taken), templ.KV("bg-primary-100", !taken) }>
				{ getPartialMedIconEmoji(med.Icon) }
			</div>
			<div class="flex-1 min-w-0">
				<span class="font-bold text-retro-dark text-sm md:text-base block truncate">{ med.Name }</span>
				<div class="flex flex-wrap gap-1 md:gap-2 mt-1">
					if med.Dosage != "" {
						<span class="retro-badge text-xs">{ med.Dosage }</span>
					}
					<span class="retro-badge text-xs">
						{ getTimesText(med.TimesPerDay) }
					</span>
					if med.DurationType == "lifetime" {
						<span class="retro-badge text-xs">Ù…Ø³ØªÙ…Ø±</span>
					}
				</div>
			</div>
		</div>

		<form
			hx-post={ "/medications/" + med.ID.String() + "/toggle" }
			hx-target={ "#med-" + med.ID.String() }
			hx-swap="outerHTML"
			class="flex-shrink-0"
		>
			<input type="hidden" name="date" value={ date.Format("2006-01-02") }/>
			if taken {
				<!-- All doses taken, next click will reset (dose_number=0 means reset) -->
				<input type="hidden" name="dose_number" value="0"/>
				<button type="submit" class="anime-btn anime-btn-success px-3 md:px-4 py-1.5 md:py-2 text-xs md:text-sm whitespace-nowrap">
					âœ“ ØªÙ…
				</button>
			} else if med.TimesPerDay > 1 {
				<!-- Multiple doses - show progress and mark next dose -->
				<input type="hidden" name="dose_number" value={ fmt.Sprintf("%d", getNextDoseNumber(med.DoseTaken)) }/>
				<button type="submit" class="anime-btn px-3 md:px-4 py-1.5 md:py-2 text-xs md:text-sm whitespace-nowrap">
					{ fmt.Sprintf("%d/%d", countTakenDoses(med.DoseTaken), med.TimesPerDay) }
				</button>
			} else {
				<!-- Single dose -->
				<input type="hidden" name="dose_number" value="1"/>
				<button type="submit" class="anime-btn px-3 md:px-4 py-1.5 md:py-2 text-xs md:text-sm whitespace-nowrap">
					Ø®Ø°Ù‡Ø§
				</button>
			}
		</form>
	</div>
}

func getTimesText(times int) string {
	if times == 1 {
		return "Ù…Ø±Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹"
	}
	return fmt.Sprintf("%d Ù…Ø±Ø§Øª", times)
}
